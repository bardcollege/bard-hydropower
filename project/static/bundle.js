window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){arguments.callee=arguments.callee.caller;var newarr=[].slice.call(arguments);(typeof console.log==='object'?log.apply.call(console.log,console,newarr):console.log.apply(console,newarr));}};(function(b){function c(){}for(var d="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,timeStamp,profile,profileEnd,time,timeEnd,trace,warn".split(","),a;a=d.pop();){b[a]=b[a]||c}})((function(){try
{console.log();return window.console;}catch(err){return window.console={};}})());var _round=function(num,len){return Math.round(num*(Math.pow(10,len)))/(Math.pow(10,len));};Number.prototype.isFloat=function(){return(this%1!==0);};var _checkIfNum=function(val){return parseFloat(val);};$("#about-btn").click(function(){$("#aboutModal").modal("show");$(".navbar-collapse.in").collapse("hide");return false;});$(document).on("load",function(){console.log("document loaded");$("#loading").hide();});var map=L.map('map',{maxZoom:22}).setView([42.0170202,-73.9144284],18);var layer_streams=L.esri.featureLayer({url:"https://services.arcgis.com/vT1c5Cjxbz2EbiZw/arcgis/rest/services/BardMicroHydro/FeatureServer/7",}).addTo(map);var layer_dams=L.esri.featureLayer({url:"https://services.arcgis.com/vT1c5Cjxbz2EbiZw/arcgis/rest/services/BardMicroHydro/FeatureServer/1",}).addTo(map);function HydroPowerClass(){this.efficiency=0.3;this.envflow=0.7;this.profile={};this.watershed={};this.area=0;this.head=0;this.power=0;this.status={"profile":null,"watershed":null};}
HydroPowerClass.prototype.calcHead=function(){var inputLine=null;var line=this.profile.OutputProfile.features[0];var coords=line.geometry.coordinates;var firstZ=coords[0][2];var lastZ=coords[coords.length-1][2];this.head=lastZ-firstZ;if(this.head<0){this.status.profile("The head calculation returned a negative value. Make sure the line was drawn downstream&rarr;upstream.");}};HydroPowerClass.prototype.getArea=function(){this.area=this.watershed.WatershedArea.features[0].properties.AreaSqKm;};HydroPowerClass.prototype.calcPower=function(x,e){if(!x){x=0.3;}
if(!e){x=0.7;}
var Qavail=(this.area*1.6);var Qenv=(this.area*x);var Quseable=Qavail-Qenv;var p=Quseable*h*(0.084)*e;this.power=_round(p,2);};HydroPowerClass.prototype.mapWatershed=function(){var watershedArea=L.featureGroup();map.addLayer(watershedArea);watershedArea.addLayer(L.geoJSON(this.watershed.WatershedArea));};HydroPowerClass.prototype.buildProfileGraphic=function(){var line=this.profile.OutputProfile.features;var el=L.control.elevation().addTo(map);L.geoJson(line,{onEachFeature:el.addData.bind(el)}).addTo(map);};hp=HydroPowerClass();$(document).on("ready",function(){$('.analysis-status').hide();$('#msg-statuses').hide();$('#msg-text').hide();$('.analyze').prop("disabled",true);$('#results-btn').prop("disabled",true);});var setParamStatus=function(selector,status){$(selector).closest('div','form-group').removeClass("has-success");$(selector).closest('div','form-group').removeClass("has-error");if(status){$(selector).closest('div','form-group').addClass("has-success");return true;}else if(status===false||isNaN(status)){$(selector).closest('div','form-group').addClass("has-error");return false;}
console.log(hp);};var checkParamStatus=function(){var checks=[];$('.params-form').each(function(i){var parsed=parseFloat(this.value);var check;if(parsed){if(this.id=='head-form-field'){check=(parsed>=0);checks.push(check);setParamStatus("#"+this.id,check);if(check){hp.head=parsed;}}
if(this.id=='area-form-field'){check=(parsed>=0);checks.push(check);setParamStatus("#"+this.id,check);if(check){hp.area=parsed;}}
if(this.id=='eff-form-field'){check=(parsed>=0||parsed<=1);checks.push(check);setParamStatus("#"+this.id,check);if(check){hp.efficiency=parsed;}}
if(this.id=='env-form-field'){check=(parsed>=0||parsed<=1);checks.push(check);setParamStatus("#"+this.id,check);if(check){hp.envflow=parsed;}}}else{setParamStatus("#"+this.id,parsed);checks.push(false);console.log(this.id+" is required.");}});if(checks.indexOf(false)==-1){return true;}else{return false;}};$('.params-form').change(function(e){var checked=checkParamStatus();if(checked){$('.analyze').prop("disabled",false);}else{$('.analyze').prop("disabled",true);}});function resetAnalysis(clearLayers,clearResults){$('#analyze-button-item').html(analyzeButton);$('.analyze').prop("disabled",true);$('#results-btn').prop("disabled",true);$('.analysis-status').empty();$('#msg-statuses').hide();$('#msg-text').empty().hide();if(clearLayers){drawnItems.clearLayers();drawInfo.update();}}
function makeAlert(msg,alertType){var defaultMsg=null;if(alertType=='info'){defaultMsg='Calculating&nbsp;&nbsp;<img src="/static/img/loading2.gif"/>';}else if(alertType=='success'){defaultMsg='Complete!';}else if(alertType=='danger'){defaultMsg="There was an error with the analysis.";}else{defaultMsg="Something went wrong. Check the browser console for details.";alertType='warning';}
var div1='<div class="alert alert-'+alertType+'" role="alert"><small>';var div2='</small></div>';if(msg){return div1+msg+div2;}else{return div1+defaultMsg+div2;}}
var analyzeButton='<div><button id="analyze" class="btn btn-primary btn-block analyze" type="submit">Calculate</button></div>';var clearButton='<div><button id="clear-btn" class="btn btn-primary btn-block analyze" type="submit">Clear Results</button></div>';var analyzeControl=L.control.custom({position:'topright',content:'<li class="list-group-item" id="analyze-button-item">'+analyzeButton+'</li>'+
'<li class="list-group-item" id="msg-statuses">'+
'<div id="msg-status" class="analysis-status"></div>'+
'<div id="msg-status-elevprofile" class="analysis-status"></div>'+
'<div id="msg-status-watershed" class="analysis-status"></div>'+
'<div id="msg-status-power" class="analysis-status"></div>'+
'</li>'+
'<li class="list-group-item" id="msg-text"></li>',classes:'list-group',id:"analyze-control",style:{width:'300px',margin:'10px',padding:'0px 0 0 0'
}});var drawnItems=L.featureGroup().addTo(map);var drawnPolyline=L.polyline([]);var drawnPoint=L.marker();map.addControl(new L.Control.Draw({edit:{featureGroup:drawnItems,},draw:{polygon:false,rectangle:false,circle:false,marker:false,polyline:{allowIntersection:false,guidelineDistance:10,shapeOptions:{stroke:true,color:'#3388ff',weight:6,opacity:0.5,fill:false,clickable:true}}}}));var drawInfo=L.control({position:'topright'});drawInfo.update=function(title,props){var msgStart='<p class="small">To begin, draw a line from a<br>point downstream to a point<br> upstream of where you would <br>locate a micro-hydro installation.<p>';this._div.innerHTML=(title?'<p>'+title+'</p>':msgStart)+(props?'<p>'+props+'</p>':'');};drawInfo.append=function(title,props){this._div.innerHTML+=(title?'<p>'+title+'</p>':msgStart)+(props?'<p>'+props+'</p>':'');};drawInfo.onAdd=function(map){this._div=L.DomUtil.create('div','drawInfo');this.update();return this._div;};drawInfo.addTo(map);var getPopupContent=function(layer){if(layer instanceof L.Polyline){var latlngs=layer._defaultShape?layer._defaultShape():layer.getLatLngs(),distance=0;if(latlngs.length<2){return"N/A";}else{for(var i=0;i<latlngs.length-1;i++){distance+=latlngs[i].distanceTo(latlngs[i+1]);}
return _round(distance,2)+" m";}}
return null;};map.on(L.Draw.Event.CREATED,function(event){console.log('draw:created');var layer=event.layer;var content=getPopupContent(layer);if(content!==null){drawInfo.update('Length: '+content,"<p>Complete the calculation by <br> with the 'calculate' button.</p>");}
drawnItems.addLayer(layer);var latlngs=layer._defaultShape?layer._defaultShape():layer.getLatLngs();drawnPolyline.setLatLngs(latlngs);drawnPoint.setLatLng(L.latLng(latlngs[latlngs.length-1]));$('#analyze').prop("disabled",false);});map.on(L.Draw.Event.EDITED,function(event){console.log('draw:edited');var layers=event.layers;var content=null;layers.eachLayer(function(layer){content=getPopupContent(layer);if(content!==null){drawInfo.update('Length: '+content,"Complete the calculation by clicking an option above.");}else{drawInfo.update('','');}
var latlngs=layer._defaultShape?layer._defaultShape():layer.getLatLngs();drawnPolyline.setLatLngs(latlngs);drawnPoint.setLatLng(L.latLng(latlngs[latlngs.length-1]));});$('#analyze').prop("disabled",false);});map.on('draw:deleted',function(e){console.log('draw:deleted');drawInfo.update('','');$('#analyze').prop("disabled",true);});$("#params-btn").click(function(){$("#paramsModal").modal("show");$(".navbar-collapse.in").collapse("hide");return false;});$(document).on("click",'.analyze',function(){resetAnalysis(false);if(!drawnPolyline.isEmpty()){console.log(drawnPolyline.toGeoJSON());console.log(drawnPoint.toGeoJSON());runGP(hp).done(analyzeGPResults);}else{}});$(document).on("click","#clear-btn",function(){console.log("clearing results");resetAnalysis(true);});$("#results-btn").click(function(){$("#resultsModal").modal("show");$(".navbar-collapse.in").collapse("hide");return false;});var runGP=function(){var e=$.Deferred();var w=$.Deferred();var elevProfileService=L.esri.GP.service({url:"http://elevation.arcgis.com/arcgis/rest/services/Tools/ElevationSync/GPServer/Profile",useCors:true,token:arcgis_token});var elevProfileTask=elevProfileService.createTask();elevProfileTask.on('initialized',function(){elevProfileTask.setParam("DEMResolution ","FINEST");elevProfileTask.setParam("ProfileIdField","OID");elevProfileTask.setParam("MaximumSampleDistance",50000);elevProfileTask.setParam("returnZ",true);elevProfileTask.setParam("InputLineFeatures",drawnPolyline.toGeoJSON());msg="Determining elevation profile...";console.log(msg);$('#msg-status-elevprofile').html(makeAlert(msg,'info'));elevProfileTask.run(function(error,result,response){if(error){msg="Elevation Profile: "+error.message+"(code:"+error.code+")";$('#msg-status-elevprofile').html(makeAlert(msg,'danger'));console.log(error.details);e.resolve(error);}else{msg="Elevation Profile: Complete";console.log(msg);console.log(result);$('#msg-status-elevprofile').html(makeAlert(msg,'success'));e.resolve(result);}});});var watershedService=L.esri.GP.service({url:"http://hydro.arcgis.com/arcgis/rest/services/Tools/Hydrology/GPServer/Watershed",useCors:true,token:arcgis_token});var watershedTask=watershedService.createTask();watershedTask.on('initialized',function(){watershedTask.setParam("InputPoints",drawnPoint.toGeoJSON());watershedTask.setParam("SourceDatabase","FINEST");watershedTask.setParam("PointIDField","OID");watershedTask.setParam("SnapDistance",500);watershedTask.setParam("Generalize",true);watershedTask.setParam("ReturnSnappedPoints",false);var outputWatershedArea;watershedTask.setOutputParam("WatershedArea");watershedTask.gpAsyncResultParam("WatershedArea",outputWatershedArea);msg="Delineating the upstream contributing area...";console.log(msg);$('#msg-status-watershed').html(makeAlert(msg,'info'));watershedTask.run(function(error,result,response){if(error){msg="Watershed: "+error.message+"(code:"+error.code+")";console.log(msg);console.log(error);$('#msg-status-watershed').html(makeAlert(msg,'danger'));w.resolve(error);}else{msg="Watershed Delineation: Complete";$('#msg-status-watershed').html(makeAlert(msg,'success'));console.log(msg);console.log(result);w.resolve(result);}});});var x=$.Deferred(function(def){$.when(e,w).done(function(eR,wR){def.resolve(eR,wR);});});return x;};var calculatePower=function(head,area,envflow,efficiency){calcRequestURL=Flask.url_for("api",{"area":area,"head":head,"envflow":envflow,"efficiency":efficiency});$.get({url:calcRequestURL,success:function(data){if(head<0){$('#msg-status').html(makeAlert("The head calculation returned a negative value. Make sure the line was drawn downstream&rarr;upstream.",'warning'));}else{$('#msg-status').hide();}
$('#msg-text').append('<h2><small>Power:</small>&nbsp;'+data.result.power+'&nbsp;<small>kW/year</small></h2>');$('#msg-status-power').html(makeAlert("Power Generation Est.: Complete",'success'));$('#analyze-button-item').html(clearButton);$('#msg-text').show();}});}
var analyzeGPResults=function(elevProfileResult,watershedResult){var msg="Calculating Power Potential...";console.log(msg);$('#msg-status-power').html(makeAlert(msg,'info'));console.log(elevProfileResult);console.log(watershedResult);var area=watershedResult.WatershedArea.features[0].properties.AreaSqKm;$('#msg-text').append('<h3><small>Area:</small>&nbsp;'+_round(area,2)+'&nbsp;<small>km^2</small></h3>');var line=elevProfileResult.OutputProfile.features[0];var coords=line.geometry.coordinates;var firstZ=coords[0][2];var lastZ=coords[coords.length-1][2];var head=Math.abs(lastZ-firstZ);$('#msg-text').append('<h3><small>Head:</small>&nbsp;'+_round(head,2)+'&nbsp;<small>meters</small></h3>');calculatePower(head,area,envflow,efficiency);var envflow=0,efficiency=0;calcRequestURL=Flask.url_for("api",{"area":area,"head":head,"envflow":envflow,"efficiency":efficiency});$.get({url:calcRequestURL,success:function(data){if(head<0){$('#msg-status').html(makeAlert("The head calculation returned a negative value. Make sure the line was drawn downstream&rarr;upstream.",'warning'));}else{$('#msg-status').hide();}
$('#msg-text').append('<h2><small>Power:</small>&nbsp;'+data.result.power+'&nbsp;<small>kW/year</small></h2>');$('#msg-status-power').html(makeAlert("Power Generation Est.: Complete",'success'));$('#analyze-button-item').html(clearButton);$('#msg-text').show();}});};